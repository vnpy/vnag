<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="monokai-sublime.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="history"></div>

    <script src="highlight.min.js"></script>
    <script src="markdown-it.min.js"></script>
    <script>
        window.onload = function() {
            const md = window.markdownit({
                html: true,
                linkify: true,
                typographer: true,
                highlight: function (str, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return '<pre class="hljs"><code>' +
                                    hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                                    '</code></pre>';
                        } catch (__) {}
                    }
                    return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
                }
            });

            function getCurrentTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }

            window.appendUserMessage = function(content) {
                const history = document.getElementById("history");
                const messageDiv = document.createElement("div");
                messageDiv.className = "message user";

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="icon">ğŸ§</div>
                        <div class="role">ç”¨æˆ·</div>
                        <div class="timestamp">${getCurrentTime()}</div>
                    </div>
                    <div class="message-content">${content}</div>
                `;

                history.appendChild(messageDiv);
                scrollToBottom();
            }

            window.appendAssistantMessage = function(markdownContent, assistantName, thinkingContent, inputTokens, outputTokens) {
                const history = document.getElementById("history");
                const messageDiv = document.createElement("div");
                messageDiv.className = "message assistant";
                
                // å­˜å‚¨åŸå§‹ markdown å†…å®¹ç”¨äºå¤åˆ¶
                messageDiv.dataset.rawContent = markdownContent;
                
                const htmlContent = md.render(markdownContent);
                const roleName = assistantName || 'Assistant';

                // æ„å»º thinking éƒ¨åˆ†çš„ HTML
                let thinkingHtml = '';
                if (thinkingContent && thinkingContent.trim()) {
                    const thinkingRendered = md.render(thinkingContent);
                    thinkingHtml = `
                        <div class="thinking-container">
                            <div class="thinking-header">
                                <span class="thinking-icon">ğŸ’¡</span>
                                <span class="thinking-label">æ€è€ƒè¿‡ç¨‹</span>
                                <span class="thinking-toggle">â–¼</span>
                            </div>
                            <div class="thinking-content">${thinkingRendered}</div>
                        </div>
                    `;
                }

                // æ„å»º token usage æ˜¾ç¤ºçš„ HTML
                let usageHtml = '';
                if (inputTokens > 0 || outputTokens > 0) {
                    usageHtml = `<span class="token-usage">In ${inputTokens.toLocaleString()} / Out ${outputTokens.toLocaleString()}</span>`;
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="icon">ğŸ¤–</div>
                        <div class="role">${roleName}</div>
                        <div class="timestamp">${getCurrentTime()}</div>
                    </div>
                    ${thinkingHtml}
                    <div class="message-content">${htmlContent}</div>
                    <div class="message-footer">
                        ${usageHtml}
                        <button class="copy-all-button" title="å¤åˆ¶å…¨æ–‡">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                `;

                // æ·»åŠ å…¨æ–‡å¤åˆ¶æŒ‰é’®äº‹ä»¶
                addCopyAllButtonEvent(messageDiv);

                // æ·»åŠ æŠ˜å /å±•å¼€åŠŸèƒ½ï¼ˆå¦‚æœæœ‰ thinkingï¼‰
                if (thinkingContent && thinkingContent.trim()) {
                    const thinkingHeader = messageDiv.querySelector('.thinking-header');
                    thinkingHeader.addEventListener('click', function() {
                        const container = this.parentElement;
                        const content = container.querySelector('.thinking-content');
                        const toggle = container.querySelector('.thinking-toggle');
                        
                        if (container.classList.contains('collapsed')) {
                            container.classList.remove('collapsed');
                            content.style.display = 'block';
                            toggle.textContent = 'â–¼';
                        } else {
                            container.classList.add('collapsed');
                            content.style.display = 'none';
                            toggle.textContent = 'â–¶';
                        }
                    });
                }

                addCopyButtons(messageDiv);
                history.appendChild(messageDiv);
                scrollToBottom();
            }

            window.startAssistantMessage = function(msgId, assistantName) {
                const history = document.getElementById("history");
                const messageDiv = document.createElement("div");
                messageDiv.id = msgId;
                messageDiv.className = "message assistant";
                messageDiv.dataset.rawContent = '';  // åˆå§‹åŒ–ä¸ºç©º

                const roleName = assistantName || 'Assistant';

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="icon">ğŸ¤–</div>
                        <div class="role">${roleName}</div>
                        <div class="timestamp">${getCurrentTime()}</div>
                    </div>
                    <div class="thinking-container" style="display: none;">
                        <div class="thinking-header">
                            <span class="thinking-icon">ğŸ’¡</span>
                            <span class="thinking-label">æ€è€ƒè¿‡ç¨‹</span>
                            <span class="thinking-toggle">â–¼</span>
                        </div>
                        <div class="thinking-content"></div>
                    </div>
                    <div class="message-content"></div>
                    <div class="message-footer">
                        <button class="copy-all-button" title="å¤åˆ¶å…¨æ–‡">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                `;

                // æ·»åŠ å…¨æ–‡å¤åˆ¶æŒ‰é’®äº‹ä»¶
                addCopyAllButtonEvent(messageDiv);

                // æ·»åŠ æŠ˜å /å±•å¼€åŠŸèƒ½
                const thinkingHeader = messageDiv.querySelector('.thinking-header');
                thinkingHeader.addEventListener('click', function() {
                    const container = this.parentElement;
                    const content = container.querySelector('.thinking-content');
                    const toggle = container.querySelector('.thinking-toggle');
                    
                    if (container.classList.contains('collapsed')) {
                        container.classList.remove('collapsed');
                        content.style.display = 'block';
                        toggle.textContent = 'â–¼';
                    } else {
                        container.classList.add('collapsed');
                        content.style.display = 'none';
                        toggle.textContent = 'â–¶';
                    }
                });

                history.appendChild(messageDiv);
                scrollToBottom();
            }

            window.updateThinking = function(msgId, thinkingContent) {
                const messageDiv = document.getElementById(msgId);
                if (messageDiv) {
                    const thinkingContainer = messageDiv.querySelector('.thinking-container');
                    const thinkingContentDiv = messageDiv.querySelector('.thinking-content');

                    // æ˜¾ç¤º thinking å®¹å™¨
                    if (thinkingContent && thinkingContent.trim()) {
                        thinkingContainer.style.display = 'block';
                    }

                    const el = document.documentElement;
                    const isScrolledToBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 1;

                    // æ¸²æŸ“ thinking å†…å®¹ï¼ˆä½¿ç”¨ markdownï¼‰
                    thinkingContentDiv.innerHTML = md.render(thinkingContent);

                    if (isScrolledToBottom) {
                        window.scrollTo(0, document.body.scrollHeight);
                    }
                }
            }

            window.updateAssistantMessage = function(msgId, markdownContent) {
                const messageDiv = document.getElementById(msgId);
                if (messageDiv) {
                    // æ›´æ–°åŸå§‹å†…å®¹
                    messageDiv.dataset.rawContent = markdownContent;

                    const contentDiv = messageDiv.querySelector('.message-content');

                    const el = document.documentElement;
                    const isScrolledToBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 1;

                    contentDiv.innerHTML = md.render(markdownContent);

                    if (isScrolledToBottom) {
                        window.scrollTo(0, document.body.scrollHeight);
                    }
                }
            }

            window.finishAssistantMessage = function(msgId, inputTokens, outputTokens) {
                const messageDiv = document.getElementById(msgId);
                if (messageDiv) {
                    addCopyButtons(messageDiv);

                    // æ·»åŠ  Token ä½¿ç”¨é‡æ˜¾ç¤ºï¼ˆåˆ†å¼€æ˜¾ç¤º input/outputï¼‰
                    if (inputTokens > 0 || outputTokens > 0) {
                        const footer = messageDiv.querySelector('.message-footer');
                        const usageSpan = document.createElement('span');
                        usageSpan.className = 'token-usage';
                        usageSpan.innerText = `In ${inputTokens.toLocaleString()} / Out ${outputTokens.toLocaleString()}`;
                        footer.insertBefore(usageSpan, footer.firstChild);
                    }
                }
            }

            function addCopyButtons(element) {
                const pres = element.querySelectorAll('pre');
                pres.forEach(pre => {
                    const button = document.createElement('button');
                    button.className = 'copy-button';
                    button.innerText = 'ğŸ“‹ å¤åˆ¶';
                    
                    button.addEventListener('click', () => {
                        const code = pre.querySelector('code').innerText;
                        navigator.clipboard.writeText(code).then(() => {
                            button.innerText = 'âœ“ å·²å¤åˆ¶';
                            setTimeout(() => {
                                button.innerText = 'ğŸ“‹ å¤åˆ¶';
                            }, 2000);
                        });
                    });
                    pre.appendChild(button);
                });
            }

            function addCopyAllButtonEvent(messageDiv) {
                const copyAllBtn = messageDiv.querySelector('.copy-all-button');
                if (copyAllBtn) {
                    copyAllBtn.addEventListener('click', function() {
                        let rawContent = messageDiv.dataset.rawContent;
                        // ç§»é™¤å·¥å…·è°ƒç”¨è®°å½•
                        rawContent = rawContent.replace(/\[æ‰§è¡Œå·¥å…·: [^\]]+\]\s*/g, '');
                        // æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
                        rawContent = rawContent.replace(/\n{3,}/g, '\n\n').trim();
                        navigator.clipboard.writeText(rawContent).then(() => {
                            this.innerText = 'âœ“ å·²å¤åˆ¶';
                            setTimeout(() => {
                                this.innerText = 'ğŸ“‹ å¤åˆ¶';
                            }, 2000);
                        });
                    });
                }
            }

            function scrollToBottom() {
                window.scrollTo(0, document.body.scrollHeight);
            }
        };
    </script>
</body>
</html>
